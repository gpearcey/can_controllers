\hypertarget{main_8cpp}{}\doxysection{main/main.cpp File Reference}
\label{main_8cpp}\index{main/main.cpp@{main/main.cpp}}


Contains Free\+RTOS tasks and pthread for sending and receiving messages between WASM app and CAN controller.  


{\ttfamily \#include $<$stdio.\+h$>$}\newline
{\ttfamily \#include \char`\"{}freertos/\+Free\+RTOS.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}freertos/task.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}NMEA\+\_\+msg.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}esp\+\_\+log.\+h\char`\"{}}\newline
{\ttfamily \#include $<$N2k\+Msg.\+h$>$}\newline
{\ttfamily \#include $<$NMEA2000\+\_\+esp32.\+h$>$}\newline
{\ttfamily \#include $<$NMEA2000.\+h$>$}\newline
{\ttfamily \#include $<$N2k\+Messages.\+h$>$}\newline
{\ttfamily \#include \char`\"{}driver/gpio.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}bi-\/inc/attr\+\_\+container.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}wasm\+\_\+export.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}bh\+\_\+read\+\_\+file.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}bh\+\_\+getopt.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}bh\+\_\+platform.\+h\char`\"{}}\newline
{\ttfamily \#include $<$queue$>$}\newline
{\ttfamily \#include $<$string$>$}\newline
{\ttfamily \#include $<$iomanip$>$}\newline
{\ttfamily \#include \char`\"{}nmea\+\_\+attack.\+h\char`\"{}}\newline
Include dependency graph for main.\+cpp\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{main_8cpp__incl}
\end{center}
\end{figure}
\doxysubsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{main_8cpp_ad16f1d8569e5ca70557cb0a89a1c59aa}\label{main_8cpp_ad16f1d8569e5ca70557cb0a89a1c59aa}} 
\#define {\bfseries NATIVE\+\_\+\+STACK\+\_\+\+SIZE}~(4$\ast$1024)
\end{DoxyCompactItemize}
\doxysubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{main_8cpp_acff9f1bcfeef64616aa107371150bf9a}\label{main_8cpp_acff9f1bcfeef64616aa107371150bf9a}} 
t\+NMEA2000\+\_\+esp32 \mbox{\hyperlink{main_8cpp_acff9f1bcfeef64616aa107371150bf9a}{NMEA2000}} (GPIO\+\_\+\+NUM\+\_\+32, GPIO\+\_\+\+NUM\+\_\+34)
\begin{DoxyCompactList}\small\item\em Creates a NMEA2000 Object set to GPIO 32 (TX), and GPIO 32 (RX) \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8cpp_a955ad07241382211a8efdeaa2307443a}{Handle\+NMEA2000\+Msg}} (const t\+N2k\+Msg \&N2k\+Msg)
\begin{DoxyCompactList}\small\item\em Creates a \mbox{\hyperlink{structNMEA__msg}{NMEA\+\_\+msg}} object and adds it to the received messages queue. \end{DoxyCompactList}\item 
std\+::string \mbox{\hyperlink{main_8cpp_ac9bab62089a524c93c540021803c6009}{nmea\+\_\+to\+\_\+string}} (\mbox{\hyperlink{structNMEA__msg}{NMEA\+\_\+msg}} \&msg)
\begin{DoxyCompactList}\small\item\em converts a \mbox{\hyperlink{structNMEA__msg}{NMEA\+\_\+msg}} to a string \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8cpp_a09ae4e0a7dffdbfb9a499ce4874a5778}{vector\+To\+Char\+Array}} (const std\+::vector$<$ uint8\+\_\+t $>$ \&data\+\_\+vec, unsigned char(\&data\+\_\+char\+\_\+arr)\mbox{[}223\mbox{]})
\begin{DoxyCompactList}\small\item\em Fills a char array with values from a vector. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8cpp_a54c259f26c52ff03f9ab1d90ba06dadf}{Print\+Str}} (wasm\+\_\+exec\+\_\+env\+\_\+t exec\+\_\+env, uint8\+\_\+t $\ast$input, int32\+\_\+t length)
\begin{DoxyCompactList}\small\item\em prints a uint8\+\_\+t array to terminal \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8cpp_af074f4615d09245f6b9582f613e1e570}{Print\+Int32}} (wasm\+\_\+exec\+\_\+env\+\_\+t exec\+\_\+env, int32\+\_\+t number, int32\+\_\+t hex)
\begin{DoxyCompactList}\small\item\em prints a integer to terminal \end{DoxyCompactList}\item 
\mbox{\Hypertarget{main_8cpp_ac689e9c910be33f383bb0d6421459c87}\label{main_8cpp_ac689e9c910be33f383bb0d6421459c87}} 
int32\+\_\+t {\bfseries Get\+Msg} (wasm\+\_\+exec\+\_\+env\+\_\+t exec\+\_\+env)
\item 
\mbox{\Hypertarget{main_8cpp_a0f2304279f04a46457288b6d28fea042}\label{main_8cpp_a0f2304279f04a46457288b6d28fea042}} 
int32\+\_\+t {\bfseries Send\+Msg} (wasm\+\_\+exec\+\_\+env\+\_\+t exec\+\_\+env, int32\+\_\+t controller\+\_\+number, int32\+\_\+t priority, int32\+\_\+t PGN, int32\+\_\+t source, uint8\+\_\+t $\ast$data, int32\+\_\+t data\+\_\+length\+\_\+bytes)
\item 
void \mbox{\hyperlink{main_8cpp_ac894d2ff5b41ee9ca73d7adb560d9416}{Send\+N2k\+Msg}} ()
\begin{DoxyCompactList}\small\item\em takes mesages out of controller queue and sends message out on that controller \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8cpp_abcaa9f46955f9eaa3af477ed9e5c9d53}{N2\+K\+\_\+task}} (void $\ast$pv\+Parameters)
\begin{DoxyCompactList}\small\item\em Free\+RTOS task for sending and receiving messages from CAN controller with NMEA2000 library. \end{DoxyCompactList}\item 
void $\ast$ \mbox{\hyperlink{main_8cpp_a3a1ac44c68d18bdde17fd90634a71222}{iwasm\+\_\+main}} (void $\ast$arg)
\begin{DoxyCompactList}\small\item\em WASM pthread to host wasm app. \end{DoxyCompactList}\item 
int \mbox{\hyperlink{main_8cpp_a144c9a97815e4b794fd4352aedd33695}{app\+\_\+main}} (void)
\begin{DoxyCompactList}\small\item\em Creates a Free\+RTOS task for sending and receiving to and from CAN Controller and creates a pthread to run WASM app. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{main_8cpp_a48df899df614d98285854d93c794813b}\label{main_8cpp_a48df899df614d98285854d93c794813b}} 
char $\ast$ \mbox{\hyperlink{main_8cpp_a48df899df614d98285854d93c794813b}{wasm\+\_\+buffer}} = NULL
\begin{DoxyCompactList}\small\item\em buffer allocated for wasm app, used to hold received messages so app can access them \end{DoxyCompactList}\item 
\mbox{\Hypertarget{main_8cpp_a8cce0fd0915d585bc2600a9520e6c9e9}\label{main_8cpp_a8cce0fd0915d585bc2600a9520e6c9e9}} 
std\+::queue$<$ \mbox{\hyperlink{structNMEA__msg}{NMEA\+\_\+msg}} $>$ \mbox{\hyperlink{main_8cpp_a8cce0fd0915d585bc2600a9520e6c9e9}{received\+\_\+msgs\+\_\+q}}
\begin{DoxyCompactList}\small\item\em Queue that stores all messages received on all controllers. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{main_8cpp_aab2ee5435f26d13831ec405df0a18ed6}\label{main_8cpp_aab2ee5435f26d13831ec405df0a18ed6}} 
std\+::queue$<$ \mbox{\hyperlink{structNMEA__msg}{NMEA\+\_\+msg}} $>$ \mbox{\hyperlink{main_8cpp_aab2ee5435f26d13831ec405df0a18ed6}{ctrl0\+\_\+q}}
\begin{DoxyCompactList}\small\item\em Queue that stores messages to be sent out on controller 0. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Contains Free\+RTOS tasks and pthread for sending and receiving messages between WASM app and CAN controller. 

\begin{DoxyRefDesc}{Todo}
\item[\mbox{\hyperlink{todo__todo000001}{Todo}}]convert relavent ESP\+\_\+\+LOGI to ESP\+\_\+\+LOGD \end{DoxyRefDesc}


\doxysubsection{Function Documentation}
\mbox{\Hypertarget{main_8cpp_a144c9a97815e4b794fd4352aedd33695}\label{main_8cpp_a144c9a97815e4b794fd4352aedd33695}} 
\index{main.cpp@{main.cpp}!app\_main@{app\_main}}
\index{app\_main@{app\_main}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{app\_main()}{app\_main()}}
{\footnotesize\ttfamily int app\+\_\+main (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Creates a Free\+RTOS task for sending and receiving to and from CAN Controller and creates a pthread to run WASM app. 

In ESP-\/\+IDF, a pthread is just a wrapper on Free\+RTOS \mbox{\Hypertarget{main_8cpp_a955ad07241382211a8efdeaa2307443a}\label{main_8cpp_a955ad07241382211a8efdeaa2307443a}} 
\index{main.cpp@{main.cpp}!HandleNMEA2000Msg@{HandleNMEA2000Msg}}
\index{HandleNMEA2000Msg@{HandleNMEA2000Msg}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{HandleNMEA2000Msg()}{HandleNMEA2000Msg()}}
{\footnotesize\ttfamily void Handle\+NMEA2000\+Msg (\begin{DoxyParamCaption}\item[{const t\+N2k\+Msg \&}]{N2k\+Msg }\end{DoxyParamCaption})}



Creates a \mbox{\hyperlink{structNMEA__msg}{NMEA\+\_\+msg}} object and adds it to the received messages queue. 

\begin{DoxyRefDesc}{Todo}
\item[\mbox{\hyperlink{todo__todo000006}{Todo}}]handle out of range data \end{DoxyRefDesc}

\begin{DoxyParams}{Parameters}
{\em N2k\+Msg} & Reference to the N2\+KMs being handled \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
void 
\end{DoxyReturn}
\mbox{\Hypertarget{main_8cpp_a3a1ac44c68d18bdde17fd90634a71222}\label{main_8cpp_a3a1ac44c68d18bdde17fd90634a71222}} 
\index{main.cpp@{main.cpp}!iwasm\_main@{iwasm\_main}}
\index{iwasm\_main@{iwasm\_main}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{iwasm\_main()}{iwasm\_main()}}
{\footnotesize\ttfamily void$\ast$ iwasm\+\_\+main (\begin{DoxyParamCaption}\item[{void $\ast$}]{arg }\end{DoxyParamCaption})}



WASM pthread to host wasm app. 

Sets up the wasm environment. Links native function to be exported. Calls wasm app function to link allocated wasm buffer. Runs main function in wasm app.


\begin{DoxyParams}{Parameters}
{\em arg} & unused -\/ I don\textquotesingle{}t know why this is required \\
\hline
\end{DoxyParams}
\mbox{\Hypertarget{main_8cpp_abcaa9f46955f9eaa3af477ed9e5c9d53}\label{main_8cpp_abcaa9f46955f9eaa3af477ed9e5c9d53}} 
\index{main.cpp@{main.cpp}!N2K\_task@{N2K\_task}}
\index{N2K\_task@{N2K\_task}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{N2K\_task()}{N2K\_task()}}
{\footnotesize\ttfamily void N2\+K\+\_\+task (\begin{DoxyParamCaption}\item[{void $\ast$}]{pv\+Parameters }\end{DoxyParamCaption})}



Free\+RTOS task for sending and receiving messages from CAN controller with NMEA2000 library. 

\begin{DoxyRefDesc}{Todo}
\item[\mbox{\hyperlink{todo__todo000005}{Todo}}]frame buffer should be 32 -\/ see if this works \end{DoxyRefDesc}

\begin{DoxyParams}{Parameters}
{\em pv\+Parameters} & \\
\hline
\end{DoxyParams}
\mbox{\Hypertarget{main_8cpp_ac9bab62089a524c93c540021803c6009}\label{main_8cpp_ac9bab62089a524c93c540021803c6009}} 
\index{main.cpp@{main.cpp}!nmea\_to\_string@{nmea\_to\_string}}
\index{nmea\_to\_string@{nmea\_to\_string}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{nmea\_to\_string()}{nmea\_to\_string()}}
{\footnotesize\ttfamily std\+::string nmea\+\_\+to\+\_\+string (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structNMEA__msg}{NMEA\+\_\+msg}} \&}]{msg }\end{DoxyParamCaption})}



converts a \mbox{\hyperlink{structNMEA__msg}{NMEA\+\_\+msg}} to a string 

\begin{DoxyRefDesc}{Todo}
\item[\mbox{\hyperlink{todo__todo000002}{Todo}}]make sure that if pgn is only 4 digits in hex it still takes 5 \end{DoxyRefDesc}

\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em msg} & reference to a \mbox{\hyperlink{structNMEA__msg}{NMEA\+\_\+msg}} object \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
std\+::string representing the message 
\end{DoxyReturn}
\mbox{\Hypertarget{main_8cpp_af074f4615d09245f6b9582f613e1e570}\label{main_8cpp_af074f4615d09245f6b9582f613e1e570}} 
\index{main.cpp@{main.cpp}!PrintInt32@{PrintInt32}}
\index{PrintInt32@{PrintInt32}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{PrintInt32()}{PrintInt32()}}
{\footnotesize\ttfamily void Print\+Int32 (\begin{DoxyParamCaption}\item[{wasm\+\_\+exec\+\_\+env\+\_\+t}]{exec\+\_\+env,  }\item[{int32\+\_\+t}]{number,  }\item[{int32\+\_\+t}]{hex }\end{DoxyParamCaption})}



prints a integer to terminal 

Native function to be exported to WASM app. Used for debugging purposes.


\begin{DoxyParams}{Parameters}
{\em exec\+\_\+env} & \\
\hline
{\em number} & integer to print \\
\hline
{\em hex} & prints the number in hex format if hex is 1, else prints it in decimal format \\
\hline
\end{DoxyParams}
\mbox{\Hypertarget{main_8cpp_a54c259f26c52ff03f9ab1d90ba06dadf}\label{main_8cpp_a54c259f26c52ff03f9ab1d90ba06dadf}} 
\index{main.cpp@{main.cpp}!PrintStr@{PrintStr}}
\index{PrintStr@{PrintStr}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{PrintStr()}{PrintStr()}}
{\footnotesize\ttfamily void Print\+Str (\begin{DoxyParamCaption}\item[{wasm\+\_\+exec\+\_\+env\+\_\+t}]{exec\+\_\+env,  }\item[{uint8\+\_\+t $\ast$}]{input,  }\item[{int32\+\_\+t}]{length }\end{DoxyParamCaption})}



prints a uint8\+\_\+t array to terminal 

Native function to be exported to WASM app. Used for debugging purposes.


\begin{DoxyParams}{Parameters}
{\em exec\+\_\+env} & \\
\hline
{\em input} & pointer to array \\
\hline
{\em length} & length of the array \\
\hline
\end{DoxyParams}
\mbox{\Hypertarget{main_8cpp_ac894d2ff5b41ee9ca73d7adb560d9416}\label{main_8cpp_ac894d2ff5b41ee9ca73d7adb560d9416}} 
\index{main.cpp@{main.cpp}!SendN2kMsg@{SendN2kMsg}}
\index{SendN2kMsg@{SendN2kMsg}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{SendN2kMsg()}{SendN2kMsg()}}
{\footnotesize\ttfamily void Send\+N2k\+Msg (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



takes mesages out of controller queue and sends message out on that controller 

\begin{DoxyRefDesc}{Todo}
\item[\mbox{\hyperlink{todo__todo000004}{Todo}}]update time to take time from message 

update for multiple controllers\end{DoxyRefDesc}
\mbox{\Hypertarget{main_8cpp_a09ae4e0a7dffdbfb9a499ce4874a5778}\label{main_8cpp_a09ae4e0a7dffdbfb9a499ce4874a5778}} 
\index{main.cpp@{main.cpp}!vectorToCharArray@{vectorToCharArray}}
\index{vectorToCharArray@{vectorToCharArray}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{vectorToCharArray()}{vectorToCharArray()}}
{\footnotesize\ttfamily void vector\+To\+Char\+Array (\begin{DoxyParamCaption}\item[{const std\+::vector$<$ uint8\+\_\+t $>$ \&}]{data\+\_\+vec,  }\item[{unsigned char(\&)}]{data\+\_\+char\+\_\+arr\mbox{[}223\mbox{]} }\end{DoxyParamCaption})}



Fills a char array with values from a vector. 

\begin{DoxyRefDesc}{Todo}
\item[\mbox{\hyperlink{todo__todo000003}{Todo}}]add in error checking if data $>$ 223 \end{DoxyRefDesc}

\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em data\+\_\+vec} & \\
\hline
\mbox{\texttt{ out}}  & {\em data\+\_\+char\+\_\+arr} & \\
\hline
\end{DoxyParams}
